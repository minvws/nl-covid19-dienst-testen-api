# API Response Signing
The API response is cryptographically signed. For this we use the Cryptographic Message Syntax [CMS](https://en.wikipedia.org/wiki/Cryptographic_Message_Syntax). This is the standard for cryptographically signing/verifying signed data and/or digital documents.

The application signs the response payload with a X509 certificate and sends the payload and signature in a json object as the response.

See the [environment variables documentation](environment-variables.md#api-response-signing) for the necessary configuration. 

<details>
    <summary>Example response</summary>

```json
{
    "payload": "eyJzdWNjZXNzIjp0cnVlfQ==",
    "signature": "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"
}
```

The payload is base64 encoded, when you decode the payload you get the following output:

```json
{
    "success": true
}
```
</details>

## Validate our response

To validate the response you need to get the certificate and chain from the party that signs the data.
Currently, the application environment is configured to sign the response with the domain certificate, but it is possible that the signing certificate differs from the domain certificate.

<details>
    <summary>Get certificate and chain from a domain name</summary>

To get the certificate and the chain from a domain you can use the following command on linux. Replace `<domain>` with the domain name.
```bash
openssl s_client -showcerts -connect <domain>:443 < /dev/null
```
</details>

<details>
    <summary>Steps to validate the response by hand</summary>
 
For example, you have the following response:
    
```json
{
    "payload": "eyJzdWNjZXNzIjp0cnVlfQ==",
    "signature": "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"
}
```

1. Split the response into a signature and content file. Replace `<response>` with the actual response.
```bash
echo '<response>' | jq -r .payload | base64 -d > payload.json
echo '<response>' | jq -r .signature | base64 -d > payload.sig
```

2. Verify the signature with the payload and check if it is signed with the expected certificates. If everything went ok, it outputs `Verification successful`. 
```bash
openssl cms -verify -inform DER -noout -CAfile chain.crt -certfile sign-certificate.crt -nointern -content payload.json < payload.sig
```

</details>
